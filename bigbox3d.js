"use strict";var opts={name:"template-",path:null,ext:"jpg",bg:"000000",bgvignette:true,bgpattern:true,bgext:null,bginterval:10,host:"",extlink:"https://github.com/theMK2k/bigbox3d",extlink_innerhtml:"scanned by MK2k, presented with <b>Big Box 3D</b>",rotation_speed:20,rotation_amortization:.91,rotation_initial_x:.15,rotation_initial_y:-.15};var basePath="";var bgimgData={cache:[],currentBgNum:0,maxBgNum:-1,bgChangeInterval:null};var gl=undefined;var tex_front=0;var tex_back=1;var tex_top=2;var tex_bottom=3;var tex_right=4;var tex_left=5;var extAnisotropic=null;var enmFaces={front:0,back:1,top:2,bottom:3,right:4,left:5};var dimensions={width:1,height:1,depth:1};var zoom=1.4;var dimensionsCalculated=false;var shaderProgram=undefined;var allTexturesLoaded=false;var texturen=new Array;var allLoaded=false;var mvMatrix=glMatrix.mat4.create();var mvMatrixStack=[];var pMatrix=glMatrix.mat4.create();var vertBuffer=null;var coordBuffer=null;var IndexBuffer=null;var xRot=0;var yRot=0;var zRot=0;var lastTime=0;var THETA=0;var PHI=0;function isNumeric(str){if(typeof str!="string")return false;return!isNaN(str)&&!isNaN(parseFloat(str))}function getQueryVariable(variable){var query=window.location.search.substring(1);var vars=query.split("&");for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");if(pair[0]==variable){return pair[1]}}return null}function hexToRgb(hex){var matches=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);var rgb=matches?{r:parseInt(matches[1],16),g:parseInt(matches[2],16),b:parseInt(matches[3],16)}:null;logger.log("hexToRgb result:",rgb);return rgb}function hasValue(value){return value!==null&&value!==undefined&&value!==""}var enmLogLevels={TRACE:0,DEBUG:1,LOG:2,INFO:3,WARN:4,ERROR:5};var logger={logLevel:enmLogLevels.WARN,trace:function trace(){if(this.logLevel>enmLogLevels.TRACE){return}for(var _len=arguments.length,data=Array(_len),_key=0;_key<_len;_key++){data[_key]=arguments[_key]}console.trace("bigbox3d",data)},debug:function debug(){if(this.logLevel>enmLogLevels.DEBUG){return}for(var _len2=arguments.length,data=Array(_len2),_key2=0;_key2<_len2;_key2++){data[_key2]=arguments[_key2]}console.debug("bigbox3d",data)},log:function log(){if(this.logLevel>enmLogLevels.LOG){return}for(var _len3=arguments.length,data=Array(_len3),_key3=0;_key3<_len3;_key3++){data[_key3]=arguments[_key3]}console.log("bigbox3d",data)},log:function log(){if(this.logLevel>enmLogLevels.INFO){return}for(var _len4=arguments.length,data=Array(_len4),_key4=0;_key4<_len4;_key4++){data[_key4]=arguments[_key4]}console.info("bigbox3d",data)},warn:function warn(){if(this.logLevel>enmLogLevels.WARN){return}for(var _len5=arguments.length,data=Array(_len5),_key5=0;_key5<_len5;_key5++){data[_key5]=arguments[_key5]}console.warn("bigbox3d",data)},error:function error(){if(this.logLevel>enmLogLevels.ERROR){return}for(var _len6=arguments.length,data=Array(_len6),_key6=0;_key6<_len6;_key6++){data[_key6]=arguments[_key6]}console.error("bigbox3d",data)}};var storedLogLevel=localStorage.getItem("logLevel");if(isNumeric(storedLogLevel)){logger.logLevel=parseInt(storedLogLevel)}else{logger.logLevel=enmLogLevels.WARN}function getLogLevel(level){var result=null;Object.keys(enmLogLevels).forEach(function(key){if(enmLogLevels[key]===level){result=key}});return result}console.info("bigbox3d","logLevel is",getLogLevel(logger.logLevel));console.info("bigbox3d","you can set another level by storing logLevel as Integer in localStorage");function calculateDimensions(){if(dimensionsCalculated){return}logger.log("texturen:",texturen);var width_absolute=texturen[enmFaces.front].image.width+texturen[enmFaces.back].image.width+texturen[enmFaces.top].image.height+texturen[enmFaces.bottom].image.height;var width_mean=width_absolute/4;var height_absolute=texturen[enmFaces.front].image.height+texturen[enmFaces.back].image.height+texturen[enmFaces.left].image.height+texturen[enmFaces.right].image.height;var height_mean=height_absolute/4;var depth_absolute=texturen[enmFaces.top].image.width+texturen[enmFaces.bottom].image.width+texturen[enmFaces.left].image.width+texturen[enmFaces.right].image.width;var depth_mean=depth_absolute/4;logger.log("width_mean:",width_mean);logger.log("height_mean:",height_mean);logger.log("depth_mean:",depth_mean);dimensions.height=height_mean/width_mean;dimensions.depth=depth_mean/width_mean;dimensions.width*=zoom;dimensions.height*=zoom;dimensions.depth*=zoom;initBuffers();dimensionsCalculated=true}function initGL(canvas){try{gl=canvas.getContext("webgl",{antialias:true});gl.viewportWidth=canvas.width;gl.viewportHeight=canvas.height;extAnisotropic=gl.getExtension("EXT_texture_filter_anisotropic")}catch(e){}if(!gl){alert("Could not initialise WebGL, sorry :-(")}}function getShader(gl,id){var shaderScript=document.getElementById(id);if(!shaderScript){return null}var str=shaderScript.text;var shader=undefined;if(shaderScript.type=="x-shader/x-fragment"){shader=gl.createShader(gl.FRAGMENT_SHADER)}else if(shaderScript.type=="x-shader/x-vertex"){shader=gl.createShader(gl.VERTEX_SHADER)}else{return null}gl.shaderSource(shader,str);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){alert(gl.getShaderInfoLog(shader));return null}return shader}function initShaders(){var fragmentShader=getShader(gl,"shader-fs");var vertexShader=getShader(gl,"shader-vs");shaderProgram={};shaderProgram.program=gl.createProgram();gl.attachShader(shaderProgram.program,vertexShader);gl.attachShader(shaderProgram.program,fragmentShader);gl.linkProgram(shaderProgram.program);if(!gl.getProgramParameter(shaderProgram.program,gl.LINK_STATUS)){alert("Could not initialise shaders")}gl.useProgram(shaderProgram.program);shaderProgram.program.vertexPositionAttribute=gl.getAttribLocation(shaderProgram.program,"aVertexPosition");gl.enableVertexAttribArray(shaderProgram.program.vertexPositionAttribute);shaderProgram.program.textureCoordAttribute=gl.getAttribLocation(shaderProgram.program,"aTextureCoord");gl.enableVertexAttribArray(shaderProgram.program.textureCoordAttribute);shaderProgram.program.pMatrixUniform=gl.getUniformLocation(shaderProgram.program,"uPMatrix");shaderProgram.program.mvMatrixUniform=gl.getUniformLocation(shaderProgram.program,"uMVMatrix");shaderProgram.program.samplerUniform=gl.getUniformLocation(shaderProgram.program,"uSampler")}function initTexture(sFilename,textures){var anz=textures.length;textures[anz]={};textures[anz].texture=gl.createTexture();textures[anz].image=new Image;textures[anz].image.onload=function(){textures[anz].isLoaded=true;gl.bindTexture(gl.TEXTURE_2D,textures[anz].texture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,false);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,textures[anz].image);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);if(extAnisotropic&&gl.getParameter(extAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)>1){logger.log("Anisotropic Filtering enabled:",gl.getParameter(extAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT));gl.texParameterf(gl.TEXTURE_2D,extAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,extAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}allTexturesLoaded=true;textures.forEach(function(tex){if(!tex.isLoaded){allTexturesLoaded=false}});document.getElementById("loading-counter").innerText=textures.filter(function(tex){return tex.isLoaded}).length;if(allTexturesLoaded){logger.log("all textures loaded!");document.getElementById("loading").style.display="none"}};textures[anz].image.src=sFilename}function mvPushMatrix(){var copy=glMatrix.mat4.create();glMatrix.mat4.copy(copy,mvMatrix);mvMatrixStack.push(copy)}function mvPopMatrix(){if(mvMatrixStack.length==0){throw"Invalid popMatrix!"}mvMatrix=mvMatrixStack.pop()}function setMatrixUniforms(){gl.uniformMatrix4fv(shaderProgram.program.pMatrixUniform,false,pMatrix);gl.uniformMatrix4fv(shaderProgram.program.mvMatrixUniform,false,mvMatrix)}function degToRad(degrees){return degrees*Math.PI/180}function initBuffers(){logger.log("initializing buffers");vertBuffer={};vertBuffer.buffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vertBuffer.buffer);var vertices=[-1*dimensions.width,-1*dimensions.height,1*dimensions.depth,1*dimensions.width,-1*dimensions.height,1*dimensions.depth,1*dimensions.width,1*dimensions.height,1*dimensions.depth,-1*dimensions.width,1*dimensions.height,1*dimensions.depth,-1*dimensions.width,-1*dimensions.height,-1*dimensions.depth,-1*dimensions.width,1*dimensions.height,-1*dimensions.depth,1*dimensions.width,1*dimensions.height,-1*dimensions.depth,1*dimensions.width,-1*dimensions.height,-1*dimensions.depth,-1*dimensions.width,1*dimensions.height,1*dimensions.depth,1*dimensions.width,1*dimensions.height,1*dimensions.depth,1*dimensions.width,1*dimensions.height,-1*dimensions.depth,-1*dimensions.width,1*dimensions.height,-1*dimensions.depth,-1*dimensions.width,-1*dimensions.height,1*dimensions.depth,-1*dimensions.width,-1*dimensions.height,-1*dimensions.depth,1*dimensions.width,-1*dimensions.height,-1*dimensions.depth,1*dimensions.width,-1*dimensions.height,1*dimensions.depth,1*dimensions.width,1*dimensions.height,-1*dimensions.depth,1*dimensions.width,1*dimensions.height,1*dimensions.depth,1*dimensions.width,-1*dimensions.height,1*dimensions.depth,1*dimensions.width,-1*dimensions.height,-1*dimensions.depth,-1*dimensions.width,1*dimensions.height,-1*dimensions.depth,-1*dimensions.width,-1*dimensions.height,-1*dimensions.depth,-1*dimensions.width,-1*dimensions.height,1*dimensions.depth,-1*dimensions.width,1*dimensions.height,1*dimensions.depth];gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertices),gl.STATIC_DRAW);vertBuffer.itemSize=3;vertBuffer.numItems=24;coordBuffer={};coordBuffer.buffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,coordBuffer.buffer);var textureCoords=[0,1,1,1,1,0,0,0,1,1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,0,0,1,1,1,1,0];gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(textureCoords),gl.STATIC_DRAW);coordBuffer.itemSize=2;coordBuffer.numItems=24;IndexBuffer=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,IndexBuffer);var Indices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(Indices),gl.STATIC_DRAW);IndexBuffer.itemSize=1;IndexBuffer.numItems=36}function drawScene(){if(!allTexturesLoaded){return}calculateDimensions();gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);glMatrix.mat4.perspective(pMatrix,perspectiveAngle,gl.viewportWidth/gl.viewportHeight,.1,100);glMatrix.mat4.identity(mvMatrix);glMatrix.mat4.translate(mvMatrix,mvMatrix,[perspectiveX,perspectiveY,-5]);glMatrix.mat4.rotate(mvMatrix,mvMatrix,degToRad(xRot),[1,0,0]);glMatrix.mat4.rotate(mvMatrix,mvMatrix,degToRad(yRot),[0,1,0]);glMatrix.mat4.rotate(mvMatrix,mvMatrix,degToRad(zRot),[0,0,0]);setMatrixUniforms();gl.bindBuffer(gl.ARRAY_BUFFER,vertBuffer.buffer);gl.vertexAttribPointer(shaderProgram.program.vertexPositionAttribute,vertBuffer.itemSize,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,coordBuffer.buffer);gl.vertexAttribPointer(shaderProgram.program.textureCoordAttribute,coordBuffer.itemSize,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,IndexBuffer);gl.bindTexture(gl.TEXTURE_2D,texturen[0].texture);gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0);gl.bindTexture(gl.TEXTURE_2D,texturen[1].texture);gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,12);gl.bindTexture(gl.TEXTURE_2D,texturen[2].texture);gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,24);gl.bindTexture(gl.TEXTURE_2D,texturen[3].texture);gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,36);gl.bindTexture(gl.TEXTURE_2D,texturen[4].texture);gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,48);gl.bindTexture(gl.TEXTURE_2D,texturen[5].texture);gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,60)}function animate(){if(!allTexturesLoaded)return;var timeNow=(new Date).getTime();if(dragMode===enmDragMode.none&&lastDragMode===enmDragMode.rotate){dX*=opts.rotation_amortization;dY*=opts.rotation_amortization;THETA+=opts.rotation_speed*dX;PHI+=opts.rotation_speed*dY}if(lastTime!=0){var elapsed=timeNow-lastTime;xRot=PHI;yRot=THETA}lastTime=timeNow}function redraw(){requestAnimationFrame(redraw);drawScene();animate()}var enmDragMode={none:0,rotate:1,move:2};var dragMode=enmDragMode.none;var lastDragMode=enmDragMode.rotate;var old_x=undefined,old_y=undefined;var dX=undefined,dY=undefined;var rotate=function rotate(e){dX=(e.pageX-old_x)*2*Math.PI/canvas.width;dY=(e.pageY-old_y)*2*Math.PI/canvas.height;THETA+=opts.rotation_speed*dX;PHI+=opts.rotation_speed*dY;old_x=e.pageX,old_y=e.pageY;e.preventDefault()};var move=function move(e){dX=(e.pageX-old_x)*2*Math.PI/canvas.width;dY=(e.pageY-old_y)*2*Math.PI/canvas.height;perspectiveX+=dX;perspectiveY-=dY;old_x=e.pageX,old_y=e.pageY;e.preventDefault()};var perspectiveAngle=45;var perspectiveX=0;var perspectiveY=0;var mouseWheel=function mouseWheel(event){if(!allTexturesLoaded)return;if(event.deltaY!==0){perspectiveAngle+=event.deltaY<0?-.02:.02}if(perspectiveAngle<44)perspectiveAngle=44;if(perspectiveAngle>46)perspectiveAngle=46;logger.log("perspectiveAngle:",perspectiveAngle);event.preventDefault()};var keyDown=function keyDown(event){logger.log("keyDown:",event);var x=0;var y=0;if(event.code==="ArrowUp"||event.code==="KeyW"){y=-.1}if(event.code==="ArrowDown"||event.code==="KeyS"){y=.1}if(event.code==="ArrowRight"||event.code==="KeyD"){x=-.1}if(event.code==="ArrowLeft"||event.code==="KeyA"){x=.1}perspectiveX+=x;perspectiveY+=y};var pointerCache=new Array;var pinch={initialPerspectiveAngle:null,initialDistance:null,initialCenter:null};function getDistance(point1,point2){var a=point1.clientX-point2.clientX;var b=point1.clientY-point2.clientY;return Math.sqrt(a*a+b*b)}function getCenter(point1,point2){var x=(point1.clientX+point2.clientX)/2;var y=(point1.clientY+point2.clientY)/2;return{x:x,y:y}}function onPointerDown(e){if(!pointerCache.find(function(pointer){return pointer.pointerId===e.pointerId})){pointerCache.push(e)}if(pointerCache.length===1){if(e.buttons===1){dragMode=enmDragMode.rotate}else if(e.buttons===2){dragMode=enmDragMode.move}else{dragMode=enmDragMode.none}old_x=e.pageX,old_y=e.pageY}if(pointerCache.length===2){pinch.initialPerspectiveAngle=perspectiveAngle;pinch.initialDistance=getDistance(pointerCache[0],pointerCache[1]);pinch.initialCenter=getCenter(pointerCache[0],pointerCache[1]);dragMode=enmDragMode.move;var center=getCenter(pointerCache[0],pointerCache[1]);old_x=center.x;old_y=center.y}e.preventDefault();return false}function onPointerMove(e){for(var i=0;i<pointerCache.length;i++){if(e.pointerId==pointerCache[i].pointerId){pointerCache[i]=e;break}}if(pointerCache.length===1){if(dragMode===enmDragMode.none){return false}else if(dragMode===enmDragMode.rotate){rotate(e)}else if(dragMode===enmDragMode.move){move(e)}}if(pointerCache.length===2){var distance=getDistance(pointerCache[0],pointerCache[1]);var diff=pinch.initialDistance-distance;perspectiveAngle=pinch.initialPerspectiveAngle+diff*.01;if(perspectiveAngle<44)perspectiveAngle=44;if(perspectiveAngle>46)perspectiveAngle=46;var center=getCenter(pointerCache[0],pointerCache[1]);move({pageX:center.x,pageY:center.y})}e.preventDefault();return false}function onPointerUp(e){logger.log("onPointerUp",e);if(pointerCache.length===1){lastDragMode=dragMode;dragMode=enmDragMode.none}for(var i=0;i<pointerCache.length;i++){if(pointerCache[i].pointerId==e.pointerId){pointerCache.splice(i,1);break}}e.preventDefault();return false}var canvas=document.querySelector("#glcanvas");function init(){logger.log("config:",config);document.getElementById("gldiv").style.opacity="1";opts.name=getQueryVariable("name")||opts.name;opts.name=opts.name.replace(/%2F/g,"/").replace(/%2520/g," ").replace(/\+/g," ");opts.path=getQueryVariable("path")||config.path||opts.path;opts.path=opts.path?opts.path.replace(/%2F/g,"/").replace(/%2520/g," ").replace(/\+/g," "):null;opts.ext=getQueryVariable("ext")||config.ext||opts.ext;opts.bgext=getQueryVariable("bgext")||config.bgext||opts.bgext;opts.bgvideo=opts.bgext==="mp4"||false;opts.bgvignette=hasValue(getQueryVariable("bgvignette"))?getQueryVariable("bgvignette")==="true"||getQueryVariable("bgvignette")==="1":hasValue(config.bgvignette)?config.bgvignette:opts.bgvignette;opts.bgpattern=hasValue(getQueryVariable("bgpattern"))?getQueryVariable("bgpattern")==="true"||getQueryVariable("bgpattern")==="1":hasValue(config.bgpattern)?config.bgpattern:opts.bgpattern;opts.bg="#"+(getQueryVariable("bg")||config.bg||opts.bg);opts.rotation_speed=config.rotation_speed||opts.rotation_speed;opts.rotation_amortization=config.rotation_amortization||opts.rotation_amortization;opts.rotation_initial_x=config.rotation_initial_x||opts.rotation_initial_x;opts.rotation_initial_y=config.rotation_initial_y||opts.rotation_initial_y;var amortization_factor=Math.abs((.91-opts.rotation_amortization)*(.91-opts.rotation_amortization)*(.91-opts.rotation_amortization)*25e3)+1;dX=opts.rotation_initial_x*(20/opts.rotation_speed)/amortization_factor;dY=opts.rotation_initial_y*(20/opts.rotation_speed)/amortization_factor;document.getElementById("gldiv").style.backgroundColor=opts.bg;document.getElementById("bg0").style.backgroundColor=opts.bg;document.getElementById("bg1").style.backgroundColor=opts.bg;logger.log("opts:",opts);if(self!==top){logger.log("embedding detected");document.getElementById("openexclusively").style.display="block"}else{logger.log("no embedding detected")}if(config.extlink&&config.extlink_innerhtml){document.getElementById("extlink_a").href=config.extlink;document.getElementById("extlink_a").innerHTML=config.extlink_innerhtml}}function webGLStart(){window.addEventListener("resizeCanvas",canvas,false);canvas.addEventListener("wheel",mouseWheel,false);window.addEventListener("keydown",keyDown,false);canvas.onpointerdown=onPointerDown;canvas.onpointermove=onPointerMove;canvas.onpointerup=onPointerUp;canvas.onpointercancel=onPointerUp;canvas.onpointerout=onPointerUp;canvas.onpointerleave=onPointerUp;function resizeCanvas(){logger.log("resize canvas!");canvas.width=window.innerWidth;canvas.height=window.innerHeight;redraw()}resizeCanvas();initGL(canvas);initShaders();var baseFullPath=(config.host||"")+(opts.path||"")+opts.name;getNextBg(baseFullPath,opts.bgext||opts.ext,opts.bgvideo);if(!opts.bgvideo){bgimgData.bgChangeInterval=setInterval(function(){getNextBg(baseFullPath,opts.bgext||opts.ext)},opts.bginterval*1e3)}if(opts.bgvignette==="true"||opts.bgvignette===true||opts.bgvignette==1){document.getElementById("glcanvas").style.boxShadow="inset 0 2px 10em 2px rgba(0, 0, 0, 0.8)"}if(opts.bgpattern==="true"||opts.bgpattern===true||opts.bgpattern==1){document.getElementById("bgfilter").style.opacity=1}document.getElementById("loading-total").innerText="6";initTexture(baseFullPath+"front."+opts.ext,texturen);initTexture(baseFullPath+"back."+opts.ext,texturen);initTexture(baseFullPath+"top."+opts.ext,texturen);initTexture(baseFullPath+"bottom."+opts.ext,texturen);initTexture(baseFullPath+"right."+opts.ext,texturen);initTexture(baseFullPath+"left."+opts.ext,texturen);gl.enable(gl.DEPTH_TEST);redraw()}function getNextBg(baseFullPath,ext,video){logger.log("[getNextBg] bgimgData.currentBgNum:",bgimgData.currentBgNum);if(video){document.getElementById("bgvideosource").src=baseFullPath+"bg"+"."+ext;document.getElementById("bgvideosource").type="video/mp4";document.getElementById("bgvideo").style.opacity="1";document.getElementById("bgvideo").load();document.getElementById("bgvideo").play();document.getElementById("bgvideocontrols").style.display="block";updateBgVideoPlayPause();return}var url=baseFullPath+"bg"+bgimgData.currentBgNum+"."+ext;if(bgimgData.maxBgNum!==-1&&bgimgData.currentBgNum>bgimgData.maxBgNum){bgimgData.currentBgNum=0}if(bgimgData.cache[bgimgData.currentBgNum]){applyBgImage(bgimgData.cache[bgimgData.currentBgNum]);bgimgData.currentBgNum++;return}fetch(url,{method:"GET"}).then(function(response){logger.log("bgimgFetch response:",response);if(response.status!==200){throw new Error("bgimgFetch failed with status "+response.status)}return response.blob()}).then(function(data){if(!data)return;document.getElementById("glcanvas").style.backgroundColor="transparent";var bgimgURL=URL.createObjectURL(data);bgimgData.cache[bgimgData.currentBgNum]=bgimgURL;applyBgImage(bgimgURL);bgimgData.currentBgNum++})["catch"](function(error){logger.log(error);if(bgimgData.currentBgNum===0){clearInterval(bgimgData.bgChangeInterval);if(opts.bgpattern){document.getElementById("glcanvas").style.backgroundSize="auto";document.getElementById("glcanvas").style.backgroundPosition="0% 0%";document.getElementById("glcanvas").style.backgroundImage='url("bg-pattern.png")'}if(opts.bgvignette){document.getElementById("glcanvas").style.boxShadow="rgba(0, 0, 0, 0.8) 0px 2px 10em 2px inset"}document.getElementById("glcanvas").style.backgroundColor=opts.bg;return}bgimgData.maxBgNum=bgimgData.currentBgNum-1;bgimgData.currentBgNum=0;applyBgImage(bgimgData.cache[0]);bgimgData.currentBgNum++})}function applyBgImage(bgimgURL){var currentBgDiv="bg"+bgimgData.currentBgNum%2;var otherBgDiv="bg"+(bgimgData.currentBgNum+1)%2;logger.log("[applyBgImage] currentBgNum:",bgimgData.currentBgNum,"currentBgDiv:",currentBgDiv,"otherBgDiv:",otherBgDiv);if(document.getElementById(currentBgDiv).style.backgroundSize!=="100% 100%"){document.getElementById(currentBgDiv).style.backgroundSize="100% 100%";document.getElementById(currentBgDiv).style.backgroundPosition="50% 50%"}document.getElementById(currentBgDiv).style.backgroundImage="url('"+bgimgURL+"')";document.getElementById(otherBgDiv).style.opacity=0;document.getElementById(currentBgDiv).style.opacity=1}function bgVideoPlayPause(){var video=document.getElementById("bgvideo");if(video.paused){video.play()}else{video.pause()}updateBgVideoPlayPause()}function updateBgVideoPlayPause(){var video=document.getElementById("bgvideo");if(video.paused){document.getElementById("bgvideocontrols").innerText="⏵"}else{document.getElementById("bgvideocontrols").innerText="⏸"}}init();webGLStart();